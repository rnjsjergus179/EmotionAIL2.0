
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>3D Ï∫êÎ¶≠ÌÑ∞ HUD, Îã¨Î†• & ÎßêÌíçÏÑ† Ï±ÑÌåÖ</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; font-family: 'Courier New', monospace; overflow: hidden; }
    
    /* Ïö∞Ï∏° Ï±ÑÌåÖÏ∞Ω */
    #right-hud {
      position: fixed;
      top: 10%;
      right: 1%;
      width: 20%;
      padding: 1%;
      background: rgba(255,255,255,0.8);
      border-radius: 5px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      z-index: 20;
    }
    #region-select {
      width: 100%;
      padding: 5px;
      font-size: 14px;
      margin-bottom: 10px;
    }
    #chat-log {
      display: none;
      height: 100px;
      overflow-y: scroll;
      border: 1px solid #ccc;
      padding: 5px;
      margin-top: 10px;
      border-radius: 3px;
      background: #fff;
    }
    #chat-input-area {
      display: flex;
      margin-top: 10px;
    }
    #chat-input {
      flex: 1;
      padding: 5px;
      font-size: 14px;
    }
    
    /* Ï¢åÏ∏° Ï∫òÎ¶∞Îçî HUD */
    #left-hud {
      position: fixed;
      top: 10%;
      left: 1%;
      width: 20%;
      padding: 1%;
      background: rgba(0,0,0,0.7);
      border: 2px solid #00ffcc;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0,255,204,0.5);
      z-index: 20;
      max-height: 80vh;
      overflow-y: auto;
      color: #00ffcc;
    }
    #left-hud h3 {
      margin-bottom: 5px;
      text-shadow: 0 0 5px #00ffcc;
    }
    #calendar-container { margin-top: 10px; }
    #calendar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 5px;
    }
    #calendar-header button {
      padding: 2px 6px;
      font-size: 12px;
      cursor: pointer;
      background: #00ffcc;
      color: #000;
      border: none;
      border-radius: 3px;
      box-shadow: 0 0 5px #00ffcc;
      transition: all 0.3s;
    }
    #calendar-header button:hover {
      background: #00cc99;
      box-shadow: 0 0 10px #00ffcc;
    }
    #month-year-label {
      font-weight: bold;
      font-size: 14px;
      text-shadow: 0 0 5px #00ffcc;
    }
    #year-select {
      font-size: 12px;
      padding: 2px;
      margin-left: 5px;
      background: #333;
      color: #00ffcc;
      border: 1px solid #00ffcc;
      border-radius: 3px;
    }
    #calendar-actions {
      margin-top: 5px;
      text-align: center;
    }
    #calendar-actions button {
      margin: 2px;
      padding: 5px 8px;
      font-size: 12px;
      cursor: pointer;
      background: #00ffcc;
      color: #000;
      border: none;
      border-radius: 3px;
      box-shadow: 0 0 5px #00ffcc;
      transition: all 0.3s;
    }
    #calendar-actions button:hover {
      background: #00cc99;
      box-shadow: 0 0 10px #00ffcc;
    }
    #calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
    }
    #calendar-grid div {
      background: rgba(255,255,255,0.1);
      border: 1px solid #00ffcc;
      border-radius: 4px;
      min-height: 25px;
      font-size: 10px;
      padding: 2px;
      position: relative;
      cursor: pointer;
      transition: all 0.3s;
    }
    #calendar-grid div:hover {
      background: rgba(0,255,204,0.3);
      box-shadow: 0 0 5px #00ffcc;
    }
    .day-number {
      position: absolute;
      top: 2px;
      left: 2px;
      font-weight: bold;
      font-size: 10px;
      color: #00ffcc;
      text-shadow: 0 0 3px #00ffcc;
    }
    .event {
      margin-top: 14px;
      font-size: 8px;
      color: #00ffcc;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      text-shadow: 0 0 3px #00ffcc;
    }
    
    /* Ï∫îÎ≤ÑÏä§ÏôÄ ÎßêÌíçÏÑ† */
    #canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
      display: block;
    }
    #speech-bubble {
      position: fixed;
      background: white;
      padding: 5px 10px;
      border-radius: 10px;
      font-size: 12px;
      display: none;
      z-index: 30;
      white-space: pre-line;
      pointer-events: none;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    /* Ïö∞Ï∏° ÏßÄÎèÑ HUD */
    #hud-3 {
      position: fixed;
      top: 70%;
      right: 1%;
      width: 20%;
      height: 20%;
      padding: 1%;
      background: rgba(255,255,255,0.9);
      border-radius: 5px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      z-index: 20;
      overflow: hidden;
    }
    
    /* ÌäúÌÜ†Î¶¨Ïñº Ïò§Î≤ÑÎ†àÏù¥ */
    #tutorial-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 100;
      opacity: 0;
      transition: opacity 1s ease-in-out;
      pointer-events: none;
    }
    #tutorial-content {
      text-align: center;
      padding: 20px;
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
      max-width: 600px;
    }
    #tutorial-content h2 { margin-bottom: 15px; }
    #tutorial-content p { margin: 10px 0; font-size: 14px; }
    
    /* Î≤ÑÏ†Ñ ÏÑ†ÌÉù ÎìúÎ°≠Îã§Ïö¥ */
    #version-select {
      position: fixed;
      bottom: 10px;
      left: 10px;
      z-index: 50;
    }
    #version-select select {
      padding: 5px;
      font-size: 12px;
    }
    
    @media (max-width: 480px) {
      #right-hud, #left-hud, #hud-3 { width: 90%; left: 5%; right: 5%; top: 5%; }
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
  <script>
    // ==============================
    // Í∞êÏ†ï ÌÇ§ÏõåÎìú Î∞è ÏùëÎãµ Îç∞Ïù¥ÌÑ∞ (Î∂ÄÎìúÎüΩÍ≥† Îã§Ï†ïÌïú AI ÎπÑÏÑú Ïä§ÌÉÄÏùº)
    // ==============================
    const emotionKeywords = {
      "Ïä¨Ìîî": ["Ïä¨ÌîÑ", "Íµ¨Ïä¨Ìîî", "Íµ¨Ïä¨Ìçº", "Íµ¨Ìîî", "ÎààÎ¨º", "Ïö∞Ïö∏"],
      "ÎØ∏Ïïà": ["ÎØ∏Ïïà", "ÎØ∏ÏïàÌñà", "Î™∞Îûè", "Î™®Î•¥Í≤†"],
      "Í∏∞ÏÅ®": ["Í∏∞ÏÅò", "ÌñâÎ≥µ", "ÏõÉ", "Í∏∞Î∂ÑÏ¢ãÏïÑ"],
      "Î∂ÑÎÖ∏": ["ÌôîÎÇú", "Î∂ÑÎÖ∏", "ÏßúÏ¶ù"],
      "ÎÜÄÎûå": ["ÎÜÄÎùº", "ÍπúÏßù", "Ïã†Í∏∞", "ÎåÄÎ∞ï"],
      "Ïù∏ÏÇ¨": ["ÏïàÎÖï", "Ïù∏ÏÇ¨", "Î∞òÍ∞ÄÏõå"],
      "ÏûòÏûê": ["ÏûòÏûê", "Ìé∏ÏïàÌïú Î∞§"]
    };
    const emotionResponses = {
      "Ïä¨Ìîî": [
        "Ï†ïÎßêÎ°ú Ïä¨ÌçºÏöî... üò¢ ÎààÎ¨ºÏù¥ Ï†àÎ°ú ÎÇòÎÑ§Ïöî.",
        "ÎßàÏùåÏù¥ ÎÑàÎ¨¥ ÏïÑÌååÏöî... üò≠",
        "Ïä¨ÌîîÏù¥ ÍπäÍ≤å ÎäêÍª¥Ï†∏Ïöî... üòî",
        "Í∑∏ Ïä¨Ìîî, Ìï®Íªò ÎÇòÎàÑÍ≥† Ïã∂Ïñ¥Ïöî... üò¢"
      ],
      "ÎØ∏Ïïà": [
        "Ï†ïÎßê ÎØ∏ÏïàÌï¥Ïöî... üôá‚Äç‚ôÄÔ∏è ÏßÑÏã¨ÏúºÎ°ú ÏÇ¨Í≥ºÎìúÎ¶ΩÎãàÎã§.",
        "ÎØ∏ÏïàÌñàÏñ¥Ïöî... üôá‚Äç‚ôÇÔ∏è",
        "ÎÇ¥ ÏûòÎ™ªÏù¥ÏóêÏöî... Ï†ïÎßê Ï£ÑÏÜ°Ìï¥Ïöî. üòû",
        "ÎØ∏ÏïàÌïòÎã§Îäî ÎßêÎ°úÎäî Î∂ÄÏ°±ÌïòÏßÄÎßå, Ï†ïÎßê Ï£ÑÏÜ°Ìï©ÎãàÎã§. üôè"
      ],
      "Í∏∞ÏÅ®": [
        "Í∏∞Î∂Ñ Ï¢ãÏïÑÏöî~ üòÑ Ï†ïÎßê ÌñâÎ≥µÌï¥Ïöî!",
        "ÏõÉÏùåÏù¥ Ï†àÎ°ú ÎÇòÎÑ§Ïöî! üòä",
        "Ïò§ÎäòÏùÄ ÎÑàÎ¨¥ Ï¶êÍ±∞ÏõåÏöî! üòÜ",
        "ÌñâÎ≥µÌïú ÌïòÎ£® Î≥¥ÎÇ¥ÏÑ∏Ïöî! üòÅ"
      ],
      "Î∂ÑÎÖ∏": [
        "Ï†ïÎßê ÌôîÍ∞Ä ÎÇòÎÑ§Ïöî... üò° Ïû†Ïãú ÏßÑÏ†ïÌï¥Î≥¥ÏÑ∏Ïöî.",
        "Î∂ÑÎÖ∏Í∞Ä ÏπòÎ∞ÄÏñ¥Ïöî! üò† Ï°∞Í∏à Ïà® Í≥†Î•¥ÏÑ∏Ïöî.",
        "ÏßúÏ¶ùÏù¥ Í∞ÄÎìùÌï¥Ïöî... üò§ ÎßàÏùåÏùÑ ÏßÑÏ†ïÏãúÌÇ§ÏÑ∏Ïöî."
      ],
      "ÎÜÄÎûå": [
        "Ï†ïÎßê ÎÜÄÎùºÏõåÏöî! üò≤",
        "ÍπúÏßù ÎÜÄÎûêÏñ¥Ïöî! üòÆ",
        "ÏÑ∏ÏÉÅÏù¥ Ï∞∏ Ïã†Í∏∞ÌïòÎÑ§Ïöî! üò≥",
        "ÎÜÄÎùºÏõÄÏù¥ Í∞ÄÎìùÌï¥Ïöî! üòØ"
      ],
      "Ïù∏ÏÇ¨": [
        "ÏïàÎÖïÌïòÏÑ∏Ïöî, Ï£ºÏù∏Îãò! Ïò§Îäò Í∏∞Î∂ÑÏùÄ Ïñ¥Îñ†ÏÑ∏Ïöî? üòä",
        "Î∞òÍ∞ëÏäµÎãàÎã§, Ï£ºÏù∏Îãò! Ïñ∏Ï†úÎÇò ÌôòÏòÅÌï¥Ïöî~ üòä",
        "ÏïàÎÖïÌïòÏã≠ÎãàÍπå? Ìï≠ÏÉÅ Í≥ÅÏóê ÏûàÍ≤†ÏäµÎãàÎã§. üôÇ"
      ],
      "ÏûòÏûê": [
        "Ïûò ÏûêÏöî, Ï¢ãÏùÄ Íøà Íæ∏ÏÑ∏Ïöî! üò¥",
        "Ìé∏ÏïàÌïú Î∞§ ÎêòÏÑ∏Ïöî... üòå",
        "ÎÇ¥ÏùºÎèÑ Î©ãÏßÑ ÌïòÎ£® ÎêòÍ∏∏ Î∞îÎûçÎãàÎã§! üåô",
        "Îã¨ÏΩ§Ìïú Íøà Íæ∏ÏÑ∏Ïöî! üò¥"
      ]
    };
    
    // ==============================
    // ÏûêÎ™® Ï°∞Ìï© Ï≤òÎ¶¨ Ìï®Ïàò
    // ÏûÖÎ†•Îêú Î¨∏ÏûêÏó¥ÏóêÏÑú Í∞Å Îã®Ïñ¥Î≥ÑÎ°ú ÎßàÏπ®ÌëúÍ∞Ä ÏûàÏúºÎ©¥ Ï†úÍ±∞ÌïòÏó¨ ÏôÑÏÑ±Îêú Îã®Ïñ¥Î°ú Í≤∞Ìï©Ìï©ÎãàÎã§.
    function combineJamo(text) {
      return text.split(" ").map(word => {
        return word.indexOf(".") !== -1 ? word.replace(/\./g, "") : word;
      }).join(" ");
    }
    
    // ==============================
    // Í∏∞Î≥∏ Í∏∞Îä•: ÏßÄÏó≠, ÎÇ†Ïî®, Ï∫òÎ¶∞Îçî Îì±
    // ==============================
    const regionMap = {
      "ÏÑúÏö∏": "Seoul",
      "Ïù∏Ï≤ú": "Incheon",
      "ÏàòÏõê": "Suwon",
      "Í≥†Ïñë": "Goyang",
      "ÏÑ±ÎÇ®": "Seongnam",
      "Ïö©Ïù∏": "Yongin",
      "Î∂ÄÏ≤ú": "Bucheon",
      "ÏïàÏñë": "Anyang",
      "ÏùòÏ†ïÎ∂Ä": "Uijeongbu",
      "Í¥ëÎ™Ö": "Gwangmyeong",
      "ÏïàÏÇ∞": "Ansan",
      "ÌååÏ£º": "Paju",
      "Î∂ÄÏÇ∞": "Busan",
      "ÎåÄÍµ¨": "Daegu",
      "Í¥ëÏ£º": "Gwangju",
      "ÎåÄÏ†Ñ": "Daejeon",
      "Ïö∏ÏÇ∞": "Ulsan",
      "Ï†úÏ£º": "Jeju",
      "Ï†ÑÏ£º": "Jeonju",
      "Ï≤≠Ï£º": "Cheongju",
      "Ìè¨Ìï≠": "Pohang",
      "Ïó¨Ïàò": "Yeosu",
      "ÍπÄÌï¥": "Gimhae"
    };
    const regionList = Object.keys(regionMap);
    let currentCity = "ÏÑúÏö∏";
    let currentWeather = "";
    let blockUntil = 0;
    let danceInterval;
    
    function saveFile() {
      const content = "ÌååÏùº Ï†ÄÏû• ÏôÑÎ£å";
      const filename = "saved_file.txt";
      const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    
    function saveCalendar() {
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
      const calendarData = {};
      for (let d = 1; d <= daysInMonth; d++) {
        const eventDiv = document.getElementById(`event-${currentYear}-${currentMonth+1}-${d}`);
        if (eventDiv && eventDiv.textContent.trim() !== "") {
          calendarData[`${currentYear}-${currentMonth+1}-${d}`] = eventDiv.textContent;
        }
      }
      localStorage.setItem("calendarEvents", JSON.stringify(calendarData));
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(calendarData, null, 2));
      const dlAnchorElem = document.createElement("a");
      dlAnchorElem.setAttribute("href", dataStr);
      dlAnchorElem.setAttribute("download", "calendar_events.json");
      dlAnchorElem.style.display = "none";
      document.body.appendChild(dlAnchorElem);
      dlAnchorElem.click();
      document.body.removeChild(dlAnchorElem);
    }
    
    function deleteCalendarEvent(day) {
      const eventDiv = document.getElementById(`event-${currentYear}-${currentMonth+1}-${day}`);
      if (eventDiv) {
        eventDiv.textContent = "";
        const calendarData = JSON.parse(localStorage.getItem("calendarEvents") || "{}");
        delete calendarData[`${currentYear}-${currentMonth+1}-${day}`];
        localStorage.setItem("calendarEvents", JSON.stringify(calendarData));
        return `${currentYear}-${currentMonth+1}-${day} ÏùºÏ†ïÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.`;
      } else {
        return "Ìï¥Îãπ ÎÇ†ÏßúÏóê ÏùºÏ†ïÏù¥ ÏóÜÏäµÎãàÎã§.";
      }
    }
    
    function getCalendarEvents(dateStr = null) {
      const calendarData = JSON.parse(localStorage.getItem("calendarEvents") || "{}");
      if (!Object.keys(calendarData).length) {
        return "Ï†ÄÏû•Îêú ÏùºÏ†ïÏù¥ ÏóÜÏäµÎãàÎã§. Î®ºÏ†Ä Ï∫òÎ¶∞ÎçîÎ•º Ï†ÄÏû•Ìï¥Ï£ºÏÑ∏Ïöî.";
      }
      if (dateStr) {
        if (calendarData[dateStr]) {
          return `${dateStr}Ïùò ÏùºÏ†ï: ${calendarData[dateStr]}`;
        } else {
          return `${dateStr}ÏóêÎäî ÏùºÏ†ïÏù¥ ÏóÜÏäµÎãàÎã§.`;
        }
      } else {
        const currentMonthStr = `${currentYear}-${currentMonth+1}`;
        let events = [];
        for (let key in calendarData) {
          if (key.startsWith(currentMonthStr)) {
            events.push(`${key}: ${calendarData[key]}`);
          }
        }
        return events.length ? `ÌòÑÏû¨ Ïõî(${currentMonthStr})Ïùò ÏùºÏ†ï:\n${events.join("\n")}`
                             : `ÌòÑÏû¨ Ïõî(${currentMonthStr})ÏóêÎäî ÏùºÏ†ïÏù¥ ÏóÜÏäµÎãàÎã§.`;
      }
    }
    
    function updateMap() {
      const englishCity = regionMap[currentCity] || "Seoul";
      document.getElementById("map-iframe").src = `https://www.google.com/maps?q=${encodeURIComponent(englishCity)}&output=embed`;
    }
    
    async function updateWeatherAndEffects(sendMessage = true) {
      const weatherData = await getWeather();
      if (sendMessage) {
        showSpeechBubbleInChunks(weatherData.message);
      }
      updateWeatherEffects();
    }
    
    function changeRegion(value) {
      currentCity = value;
      updateMap();
      updateWeatherAndEffects();
      showSpeechBubbleInChunks(`ÏßÄÏó≠Ïù¥ ${value}(Ïúº)Î°ú Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.`);
    }
    
    // ==============================
    // Ï±ÑÌåÖ ÏûÖÎ†• Ï≤òÎ¶¨ ‚Äì Í∞êÏ†ï ÌÇ§ÏõåÎìú Î∞è ÏûêÎ™® Ï°∞Ìï© Ï≤òÎ¶¨
    // ==============================
    async function sendChat() {
      const inputEl = document.getElementById("chat-input");
      let input = inputEl.value.trim();
      
      if (Date.now() < blockUntil) {
        showSpeechBubbleInChunks("1ÏãúÍ∞ÑÎèôÏïà Ï∞®Îã®Îê©ÎãàÎã§.");
        inputEl.value = "";
        return;
      }
      if (!input) return;
      
      // ÏûêÎ™® Ï°∞Ìï© Ï≤òÎ¶¨: Îã®Ïñ¥Î≥ÑÎ°ú '.'Í∞Ä Ìè¨Ìï®ÎêòÏñ¥ ÏûàÏúºÎ©¥ Í≤∞Ìï©ÌïòÏó¨ ÌïòÎÇòÏùò Îã®Ïñ¥Î°ú ÎßåÎì¶
      input = combineJamo(input);
      
      let response = "";
      const lowerInput = input.toLowerCase();
      
      // ÏßÄÏó≠ Î≥ÄÍ≤Ω Ï≤òÎ¶¨
      if (lowerInput.startsWith("ÏßÄÏó≠ ")) {
        const newCity = lowerInput.replace("ÏßÄÏó≠", "").trim();
        if (newCity) {
          if (regionList.includes(newCity)) {
            currentCity = newCity;
            document.getElementById("region-select").value = newCity;
            response = `ÏßÄÏó≠Ïù¥ ${newCity}(Ïúº)Î°ú Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.`;
            updateMap();
            await updateWeatherAndEffects();
          } else {
            response = "ÏßÄÏõêÌïòÏßÄ ÏïäÎäî ÏßÄÏó≠ÏûÖÎãàÎã§. ÎìúÎ°≠Îã§Ïö¥ Î©îÎâ¥ÏóêÏÑú ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.";
          }
        } else {
          response = "Î≥ÄÍ≤ΩÌï† ÏßÄÏó≠ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.";
        }
      } else if (regionList.includes(lowerInput)) {
        currentCity = lowerInput;
        document.getElementById("region-select").value = lowerInput;
        response = `ÏßÄÏó≠Ïù¥ ${lowerInput}(Ïúº)Î°ú Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.`;
        updateMap();
        await updateWeatherAndEffects();
      }
      
      // Í∞êÏ†ï ÌÇ§ÏõåÎìú Î∂ÑÏÑù
      const detectedEmotions = detectEmotion(input);
      if (detectedEmotions.length > 0) {
        const emotion = detectedEmotions[0]; // Ï≤´Î≤àÏß∏ Í∞êÏ†ïÎßå Ï≤òÎ¶¨ (Î≥µÌï© Í∞êÏ†ïÏùÄ Ï∂îÌõÑ ÌôïÏû• Í∞ÄÎä•)
        const responses = emotionResponses[emotion];
        if (responses && responses.length > 0) {
          response = responses[Math.floor(Math.random() * responses.length)];
        }
      }
      
      // Í∏∞Î≥∏ Ï≤òÎ¶¨: ÎÇ†Ïî®, ÏãúÍ∞Ñ, Ï∫òÎ¶∞Îçî Îì±
      if (!response) {
        if (lowerInput.includes("ÎÇ†Ïî®") &&
            (lowerInput.includes("ÏïåÎ†§") || lowerInput.includes("Ïñ¥Îïå") ||
             lowerInput.includes("Î≠êÏïº") || lowerInput.includes("Ïñ¥ÎñªÍ≤å") || lowerInput.includes("ÎßëÏïÑ"))) {
          await updateWeatherAndEffects();
          return;
        } else if (lowerInput.includes("ÏãúÍ∞Ñ") || lowerInput.includes("Î™áÏãú") || lowerInput.includes("ÌòÑÏû¨ÏãúÍ∞Ñ")) {
          const now = new Date();
          const hours = now.getHours();
          const minutes = now.getMinutes();
          response = `ÌòÑÏû¨ ÏãúÍ∞ÑÏùÄ ${hours}Ïãú ${minutes}Î∂ÑÏûÖÎãàÎã§.`;
        } else if (lowerInput.includes("ÌååÏùº Ï†ÄÏû•Ìï¥Ï§ò")) {
          response = "ÌååÏùº Ï†ÄÏû•ÌïòÍ≤†ÏäµÎãàÎã§.";
          saveFile();
        } else if ((lowerInput.includes("Ï∫òÎ¶∞Îçî") && lowerInput.includes("Ï†ÄÏû•")) ||
                   lowerInput.includes("ÏùºÏ†ïÏ†ÄÏû•") ||
                   lowerInput.includes("ÌïòÎ£®ÏùºÍ≥ºÏ†ÄÏû•")) {
          response = "Ï∫òÎ¶∞Îçî Ï†ÄÏû•ÌïòÍ≤†ÏäµÎãàÎã§.";
          saveCalendar();
        } else if (lowerInput.includes("ÏùºÏ†ï ÏÇ≠Ï†ú") || 
                   lowerInput.includes("ÌïòÎ£®ÏùºÏ†ï ÏÇ≠Ï†ú") || 
                   lowerInput.includes("ÏùºÏ†ï ÏÇ≠Ï†úÌï¥Ï§ò") || 
                   lowerInput.includes("ÌïòÎ£® ÏùºÏ†ï ÏÇ≠Ï†ú")) {
          const dayStr = prompt("ÏÇ≠Ï†úÌï† ÏùºÏ†ïÏùò ÎÇ†Ïßú(Ïùº)Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî (Ïòà: 15):");
          if (dayStr) {
            const dayNum = parseInt(dayStr);
            if (dayNum >= 1 && dayNum <= new Date(currentYear, currentMonth+1, 0).getDate()) {
              response = deleteCalendarEvent(dayNum);
            } else {
              response = "Ïú†Ìö®Ìïú ÎÇ†ÏßúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.";
            }
          } else {
            response = "ÎÇ†ÏßúÎ•º ÏûÖÎ†•ÌïòÏßÄ ÏïäÏúºÏÖ®ÏäµÎãàÎã§.";
          }
        } else if (lowerInput.includes("ÏùºÏ†ï ÏïåÎ†§Ï§ò") || 
                   lowerInput.includes("ÏùºÏ†ï ÏïåÎ†§") || 
                   lowerInput.includes("ÏùºÏ†ï ÌôïÏù∏")) {
          const dateMatch = input.match(/\d{4}-\d{1,2}-\d{1,2}/);
          if (dateMatch) {
            const dateStr = dateMatch[0];
            response = getCalendarEvents(dateStr);
          } else {
            response = getCalendarEvents();
          }
        } else if (lowerInput.includes("ÏïàÎÖï")) {
          response = "ÏïàÎÖïÌïòÏÑ∏Ïöî, Ï£ºÏù∏Îãò! Ïò§Îäò Í∏∞Î∂ÑÏùÄ Ïñ¥Îñ†ÏÑ∏Ïöî?";
          characterGroup.children[7].rotation.z = Math.PI / 4;
          setTimeout(() => { characterGroup.children[7].rotation.z = 0; }, 1000);
        } else if (lowerInput.includes("Ï∫êÎ¶≠ÌÑ∞ ÎÑå ÎàÑÍµ¨Ïïº")) {
          response = "Ï†ÄÎäî ÎãπÏã†Ïùò Î∂ÄÎìúÎüΩÍ≥† Îã§Ï†ïÌïú ÎπÑÏÑúÏûÖÎãàÎã§.";
        } else if (lowerInput.includes("ÏùºÏ†ï")) {
          response = "Ï∫òÎ¶∞ÎçîÎäî ÏôºÏ™ΩÏóêÏÑú ÌôïÏù∏ÌïòÏÑ∏Ïöî.";
        } else if (lowerInput.includes("Ï∫êÎ¶≠ÌÑ∞ Ï∂§Ï∂∞Ï§ò") ||
                   lowerInput.includes("Ï∂§") ||
                   lowerInput.includes("Ï∂§Ï∂∞") ||
                   lowerInput.includes("Ï∂§Ï∂∞Ï§ò") ||
                   lowerInput.includes("Ï∂§Ï∂∞Î¥ê") ||
                   lowerInput.includes("Ï∂§ÏÇ¨ÏúÑ")) {
          response = "Ï∂§Ï∂îÍ≤†ÏäµÎãàÎã§! Ïû†ÏãúÎßå Í∏∞Îã§Î†§ Ï£ºÏÑ∏Ïöî.";
          if (danceInterval) clearInterval(danceInterval);
          danceInterval = setInterval(() => {
            characterGroup.children[7].rotation.z = Math.sin(Date.now() * 0.01) * Math.PI / 4;
            head.rotation.y = Math.sin(Date.now() * 0.01) * Math.PI / 8;
          }, 50);
          setTimeout(() => {
            clearInterval(danceInterval);
            characterGroup.children[7].rotation.z = 0;
            head.rotation.y = 0;
          }, 3000);
        } else {
          response = "Ï£ÑÏÜ°Ìï©ÎãàÎã§. Ïûò Ïù¥Ìï¥ÌïòÏßÄ Î™ªÌñàÏäµÎãàÎã§. Îã§Ïãú ÎßêÏîÄÌï¥Ï£ºÏãúÍ≤†Ïñ¥Ïöî?";
        }
      }
      
      showSpeechBubbleInChunks(response);
      inputEl.value = "";
    }
    
    async function getWeather() {
      try {
        const englishCity = regionMap[currentCity] || "Seoul";
        const url = `https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(englishCity)}&appid=${weatherKey}&units=metric&lang=kr`;
        const res = await fetch(url);
        if (!res.ok) throw new Error("ÎÇ†Ïî® API Ìò∏Ï∂ú Ïã§Ìå®");
        const data = await res.json();
        const description = data.weather[0].description;
        const temp = data.main.temp;
        currentWeather = description;
        let extraComment = "";
        if (description.indexOf("ÌùêÎ¶º") !== -1 || description.indexOf("Íµ¨Î¶Ñ") !== -1) {
          extraComment = " Ïò§ÎäòÏùÄ ÏïΩÍ∞Ñ ÌùêÎ¶∞ ÎÇ†Ïî®ÎÑ§Ïöî ‚òÅÔ∏è";
        } else if (description.indexOf("ÎßëÏùå") !== -1) {
          extraComment = " Ïò§ÎäòÏùÄ ÎßëÏùÄ ÎÇ†Ïî®ÎÑ§Ïöî ‚òÄÔ∏è";
        } else if (description.indexOf("ÎπÑ") !== -1 || description.indexOf("ÏÜåÎÇòÍ∏∞") !== -1) {
          extraComment = " Ïò§ÎäòÏùÄ ÎπÑÍ∞Ä Ïò§ÎÑ§Ïöî ‚òî";
        }
        return { message: `Ïò§Îäò ${currentCity}Ïùò ÎÇ†Ïî®Îäî ${description}Ïù¥Î©∞, Ïò®ÎèÑÎäî ${temp}¬∞CÏûÖÎãàÎã§.${extraComment}` };
      } catch (err) {
        currentWeather = "";
        return { message: `ÎÇ†Ïî® Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§: ${currentCity}` };
      }
    }
    
    function updateWeatherEffects() {
      if (!currentWeather) return;
      if (currentWeather.indexOf("ÎπÑ") !== -1 || currentWeather.indexOf("ÏÜåÎÇòÍ∏∞") !== -1) {
        rainGroup.visible = true;
        houseCloudGroup.visible = false;
      } else if (currentWeather.indexOf("Íµ¨Î¶Ñ") !== -1 || currentWeather.indexOf("ÌùêÎ¶º") !== -1) {
        rainGroup.visible = false;
        houseCloudGroup.visible = true;
      } else {
        rainGroup.visible = false;
        houseCloudGroup.visible = false;
      }
    }
    
    function updateLightning() {
      if (currentWeather.indexOf("Î≤àÍ∞ú") !== -1 || currentWeather.indexOf("ÎáåÏö∞") !== -1) {
        if (Math.random() < 0.001) {
          lightningLight.intensity = 5;
          setTimeout(() => { lightningLight.intensity = 0; }, 100);
        }
      }
    }
    
    function showSpeechBubbleInChunks(text, chunkSize = 15, delay = 3000) {
      const bubble = document.getElementById("speech-bubble");
      const chunks = [];
      for (let i = 0; i < text.length; i += chunkSize) {
        chunks.push(text.slice(i, i + chunkSize));
      }
      let index = 0;
      function showNextChunk() {
        if (index < chunks.length) {
          bubble.textContent = chunks[index];
          bubble.style.display = "block";
          index++;
          setTimeout(showNextChunk, delay);
        } else {
          setTimeout(() => { bubble.style.display = "none"; }, 3000);
        }
      }
      showNextChunk();
    }
    
    window.addEventListener("DOMContentLoaded", function() {
      document.getElementById("chat-input").addEventListener("keydown", function(e) {
        if (e.key === "Enter") sendChat();
      });
      const regionSelect = document.getElementById("region-select");
      regionList.forEach(region => {
        const option = document.createElement("option");
        option.value = region;
        option.textContent = `${region} (${regionMap[region]})`;
        if (region === currentCity) option.selected = true;
        regionSelect.appendChild(option);
      });
    });
    
    window.addEventListener("resize", function(){
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
    
    window.addEventListener("load", async () => {
      initCalendar();
      showTutorial();
      updateMap();
      await updateWeatherAndEffects();
    });
    
    function changeVersion(version) {
      if (version === "1.3") {
        window.location.href = "https://aipersonalassistant.neocities.org/";
      } else if (version === "latest") {
        window.location.reload();
      }
    }
  </script>
</body>
</html>
